/**
 * @license
 * Copyright (c) 2014, 2025, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["exports","ojs/ojcore-base","ojs/ojdatagridprovider","ojs/ojeventtarget","ojs/ojdatacollection-common"],function(e,t,a,s,i){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t;class r{constructor(e,t){if(this.dataProvider=e,this.options=t,this.version=0,this.keyCache=[],this.lastRowKeyCached=!1,this.GridItem=class{constructor(e,t){this.metadata=e,this.data=t}},this.GridBodyItem=class{constructor(e,t,a,s,i,r){this.rowExtent=e,this.columnExtent=t,this.rowIndex=a,this.columnIndex=s,this.metadata=i,this.data=r}},this.GridHeaderItem=class{constructor(e,t,a,s,i,r){this.index=e,this.extent=t,this.level=a,this.depth=s,this.metadata=i,this.data=r}},this.GridHeaderMetadata=class{constructor(e,t,a,s,i){this.sortDirection=e,this.filter=t,this.expanded=a,this.treeDepth=s,this.showRequired=i}},this.FetchByOffsetGridResults=class{constructor(e,t,a,s,i,r,o,n,l,d,h,u){this.fetchParameters=e,this.rowDone=t,this.columnDone=a,this.rowOffset=s,this.columnOffset=i,this.rowCount=r,this.columnCount=o,this.totalRowCount=n,this.totalColumnCount=l,this.results=d,this.version=h,this.next=u}},this.sortable=t?.sortable,this.sortCriteria=null,this.filterable=t?.filterable,this.filterCriteria=null,this.supportsFilteredRowCount="exact"===e.getCapability("fetchFirst")?.totalFilteredRowCount,t?.expandedObservable){t?.expandedObservable.subscribe(e=>{this.expandedState=e.value})}e.addEventListener("mutate",this._handleUnderlyingMutation.bind(this)),e.addEventListener("refresh",this._handleUnderlyingRefresh.bind(this)),t?.itemMetadata&&(this.itemMetadata=t?.itemMetadata)}async fetchByOffset(e){const t=e.rowOffset;let a=e.rowCount,s={results:[],done:!1,fetchParameters:null};0!=a&&(s=await this.dataProvider.fetchByOffset({offset:t,size:a}),this.sortCriteria=s.fetchParameters?.sortCriteria,this.filterCriteria=s.fetchParameters?.filterCriterion);let i=-1;if(!this.isSameFetchParameters(s.fetchParameters)||null==this.totalRowCount){if(this.supportsFilteredRowCount){let e=await this.dataProvider.fetchFirst({size:1,includeFilteredRowCount:"enabled"})[Symbol.asyncIterator]().next();null!=e.value.totalFilteredRowCount&&(i=e.value.totalFilteredRowCount)}else this.isUnfiltered(s.fetchParameters)&&(i=await this.dataProvider.getTotalSize());this.totalRowCount=i}this.updateKeyCache(s,t),this.setupLayout(s.results);const r=e.columnOffset,o=r+e.columnCount>=this.columns.databody.length,n=Math.max(Math.min(e.columnCount,this.columns.databody.length-r),0);a=Math.min(e.rowCount,s.results.length);const l=s.done;this.lastRowKeyCached=s.done;const d=this.version,h=e.fetchRegions,u=null==h||h.has("all"),c=u||h?.has("databody"),m=u||h?.has("rowHeader"),f=u||h?.has("columnHeader"),b=u||h?.has("rowEndHeader"),w=u||h?.has("columnEndHeader"),p=u||h?.has("rowHeaderLabel"),y=u||h?.has("columnHeaderLabel"),C=u||h?.has("rowEndHeaderLabel"),H=u||h?.has("columnEndHeaderLabel"),g=c?this.getDatabodyResults(s.results,t,a,r,n):void 0,v=m?this.getRowHeaderResults("rowHeader",s.results,t,a):void 0,E=b?this.getRowHeaderResults("rowEndHeader",s.results,t,a):void 0,R=f?this.getColumnHeaderResults("column",r,n):void 0,L=w?this.getColumnHeaderResults("columnEnd",r,n):void 0,x=p?this.getRowHeaderLabelResults():void 0,O=C?this.getRowEndHeaderLabelResults():void 0,M={databody:g,columnHeader:R,columnHeaderLabel:y?this.getColumnHeaderLabelResults("column"):void 0,columnEndHeader:L,columnEndHeaderLabel:H?this.getColumnHeaderLabelResults("columnEnd"):void 0,rowHeader:v,rowHeaderLabel:x,rowEndHeader:E,rowEndHeaderLabel:O};return new this.FetchByOffsetGridResults(e,l,o,t,r,a,n,this.totalRowCount,this.columns.databody.length,M,d,null)}updateKeyCache(e,t){let a=e.fetchParameters;this.isSameFetchParameters(a)||this._clearKeyCache(),this.currentFetchParameters=a,e.results.forEach((e,a)=>{this.keyCache[t+a]=e.metadata.key})}_clearKeyCache(){this.keyCache=[]}isKeyCacheSparse(){for(let e=0;e<this.keyCache.length;e++)if(void 0===this.keyCache[e])return!0;return!1}isSameFetchParameters(e){let a=e?.sortCriteria,s=e?.filterCriterion,i=this.currentFetchParameters?.sortCriteria,r=this.currentFetchParameters?.filterCriterion;return!((null!=a&&null!=i||a!=i)&&!t.Object.compareValues(a,i))&&!((null!=s&&null!=i||s!=r)&&!t.Object.compareValues(s,r))}isUnfiltered(e){return null==e||null==e.filterCriterion}setupLayout(e){this.setupColumns(e),this.setupColumnHeaders(),this.setupHeaderLabels()}setupColumns(e){if(null==this.columns){this.columns={};const t=e[0];if(this.columns.rowHeader=this.getFromOptions(this.options?.columns?.rowHeader,t),this.columns.rowEndHeader=this.getFromOptions(this.options?.columns?.rowEndHeader,t),this.options?.columns?.databody){let e=this.options.columns.databody;this.columns.databody="function"==typeof e?e(t):e}else if(null==t)this.columns.databody=[];else{const e=Object.keys(t.data);this.columns.databody=e.filter(e=>!this.columns.rowHeader?.includes(e)&&!this.columns.rowEndHeader?.includes(e))}}}setupColumnHeaders(){if(null==this.columnHeaders){this.columnHeaders={};const e=this.getFromOptions(this.options?.columnHeaders?.column,this.columns?.databody,this.columns?.databody,e=>({data:e}));this.columnHeaders.column=this.parseNestedHeaders(e);const t=this.getFromOptions(this.options?.columnHeaders?.columnEnd,this.columns?.databody,this.columns?.databody,e=>({data:e}));this.columnHeaders.columnEnd=this.parseNestedHeaders(t)}}setupHeaderLabels(){null==this.headerLabels&&(this.headerLabels={},this.headerLabels.row=this.getFromOptions(this.options?.headerLabels?.row,this.columns?.rowHeader,this.columns?.rowHeader,e=>e),this.headerLabels.rowEnd=this.getFromOptions(this.options?.headerLabels?.rowEnd,this.columns?.rowEndHeader,this.columns?.rowEndHeader,e=>e),this.headerLabels.column=this.getFromOptions(this.options?.headerLabels?.column,this.columnHeaders?.column?.headerArray),this.headerLabels.columnEnd=this.getFromOptions(this.options?.headerLabels?.columnEnd,this.columnHeaders?.columnEnd?.headerArray))}getFromOptions(e,t,a,s){if(null!=e)return"function"==typeof e?e(t):a&&"attributeName"===e?a.map(s):e}parseNestedHeaders(e){if(null==e)return;"string"==typeof e[0]&&(e=e.map(e=>({data:e})));let t=[],a=1;const s=(e,i,r)=>{let o=0;return e.forEach(e=>{let n=e.depth||1,l=1;e.children&&(l=s(e.children,i,r+n));let d={index:i,extent:l,level:r,depth:n,data:e.data};t.push(d),a=Math.max(a,r+1),o+=l,i+=l}),o};return s(e,0,0),{headerArray:t,levelCount:a}}getCapability(e){return"version"===e?"monotonicallyIncreasing":null}isEmpty(){return"unknown"}setDataProvider(e){this.dataProvider=e}updateItemMetadata(e){let t={ranges:e,version:this.version};this.dispatchEvent(new a.DataGridProviderUpdateEvent(t))}getDatabodyResults(e,t,a,s,i){if(e?.length>0){const r=[];for(let o=0;o<a;o++){const a=e[o];for(let e=0;e<i;e++){const i=this.columns.databody[s+e],n={data:a.data[i]};let l={rowItem:a};const d=new this.GridBodyItem(1,1,t+o,s+e,l,n);if(this.itemMetadata&&"function"==typeof this.itemMetadata.databody){let e=this.itemMetadata.databody(d);e&&Object.assign(d.metadata,e)}r.push(d)}}return r}}getRowHeaderResults(e,t,a,s){const i=this.columns[e];if(t?.length>0&&i?.length>0){const r=[];for(let o=i.length-1;o>=0;o--){const n=i[o];for(let i=0;i<s;i++){const s=a+i,l=t[i],d={data:l.data[n]};let h,u=l.metadata.treeDepth;this.expandedState&&!1===l.metadata.isLeaf&&(h=this.expandedState.has(l.metadata.key)?"expanded":"collapsed");const c={rowItem:l,expanded:h,treeDepth:u},m=new this.GridHeaderItem(s,1,o,1,c,d);"rowHeader"===e&&null!=this.itemMetadata?.rowHeader?Object.assign(m.metadata,this.itemMetadata?.rowHeader(m)):"rowEndHeader"===e&&null!=this.itemMetadata?.rowEndHeader&&Object.assign(m.metadata,this.itemMetadata.rowEndHeader(m)),r.push(m)}}return r}}getSortState(e,t){let a;if(a="column"===t?this.columns.databody[e]:this.headerLabels[t][e],this.sortCriteria&&this.sortCriteria.length>0&&a){let e=this.sortCriteria[0];if(e.attribute===a)return e.direction}return"unsorted"}getFilterState(e,t){let a;return a="column"===t?this.columns.databody[e]:this.headerLabels[t][e],this.filterCriteria&&a&&i.doesAttributeExistInFilterCriterion(a,this.filterCriteria)?"filtered":"filterable"}getColumnHeaderResults(e,t,a){if(this.columnHeaders?.[e]){const s=[],i=[],r=this.columnHeaders[e].levelCount;for(let o=0;o<a;o++){const a=t+o;for(let t=0;t<r;t++){if(i[a]?.[t])continue;const o=this.getColumnHeaderItem(a,t,this.columnHeaders[e].headerArray),n={data:o.data},l=o.index,d=o.extent,h=o.level,u=o.depth;let c,m,f;"column"===e&&t+u===r?((this.sortable||null!=this.itemMetadata?.columnHeader&&this.sortCriteria?.length)&&(m=this.getSortState(l,e)),(this.filterable||this.filterCriteria)&&(f=this.getFilterState(l,e)),c=new this.GridHeaderMetadata(m,f)):c={};const b=new this.GridHeaderItem(l,d,h,u,c,n);"column"===e&&null!=this.itemMetadata?.columnHeader?Object.assign(b.metadata,this.itemMetadata?.columnHeader(b)):"columnEnd"===e&&null!=this.itemMetadata?.columnEndHeader&&Object.assign(b.metadata,this.itemMetadata.columnEndHeader(b)),s.push(b);for(let e=l;e<l+d;e++){null==i[e]&&(i[e]=[]);for(let a=t;a<t+u;a++)i[e][a]=!0}}}return s}}getColumnHeaderItem(e,t,a){return a.find(a=>{let s=a.index,i=a.extent,r=a.level,o=a.depth;return e>=s&&e<s+i&&t>=r&&t<r+o})}getRowHeaderLabelResults(){let e;if("attributeName"===this.headerLabels?.row?e=this.columns.rowHeader:this.headerLabels?.row&&(e=this.headerLabels.row),e){let e=[];for(let t=this.headerLabels.row.length-1;t>=0;t--){let a;(this.sortable||this.sortCriteria?.length)&&(a=this.getSortState(t,"row"));let s={sortDirection:a};const i=new this.GridItem(s,{data:this.headerLabels.row[t]});null!=this.itemMetadata?.rowHeaderLabel&&Object.assign(i.metadata,this.itemMetadata.rowHeaderLabel(i)),e.push(i)}return e}}getRowEndHeaderLabelResults(){let e;if("attributeName"===this.headerLabels?.rowEnd?e=this.columns.rowEndHeader:this.headerLabels?.rowEnd&&(e=this.headerLabels.rowEnd),e){let e=[];for(let t=this.headerLabels.rowEnd.length-1;t>=0;t--){let a;(this.sortable||this.sortCriteria?.length)&&(a=this.getSortState(t,"rowEnd"));let s={sortDirection:a};const i=new this.GridItem(s,{data:this.headerLabels.rowEnd[t]});null!=this.itemMetadata?.rowEndHeaderLabel&&Object.assign(i.metadata,this.itemMetadata.rowEndHeaderLabel(i)),e.push(i)}return e}}getColumnHeaderLabelResults(e){if(this.headerLabels?.[e]){let t=[];for(let a=this.headerLabels[e].length-1;a>=0;a--){let s;this.sortable&&(s=this.getSortState(a,"row"));let i={sortDirection:s};const r=new this.GridItem(i,{data:this.headerLabels[e][a]});"column"===e&&null!=this.itemMetadata?.columnHeaderLabel?Object.assign(r.metadata,this.itemMetadata.columnHeaderLabel(r)):"columnEnd"===e&&null!=this.itemMetadata?.columnEndHeaderLabel&&Object.assign(r.metadata,this.itemMetadata.columnEndHeaderLabel(r)),t.push(r)}return t}}_handleUnderlyingMutation(e){this.version++;let t,s,r,o,n=e.detail,l=!1,d=this.isKeyCacheSparse(),h=this.lastRowKeyCached&&!d;if(n.remove&&n.remove.keys.size>0&&([l,t,o]=this._convertEventDetail(n.remove,"remove",d)),o?.sort((e,t)=>t.index-e.index).forEach(e=>{this.keyCache.splice(e.index,1),-1!==this.totalRowCount&&(this.totalRowCount-=1)}),!l&&n.add&&n.add.keys.size>0){let e=i.getAddEventKeysResult(this.keyCache,n.add,h);if(l=d&&e.length!==this.keyCache.length+n.add.keys.size,!l){let t=[];n.add.keys.forEach(a=>{let s=e.indexOf(a),i=t.find(e=>s===e.offset+e.count);i?i.count+=1:t.push({offset:s,count:1}),-1!==this.totalRowCount&&(this.totalRowCount+=1)}),r={axis:"row",ranges:t,version:this.version},this.keyCache=e}}!l&&n.update&&n.update.keys.size>0&&([l,s]=this._convertEventDetail(n.update,"update",d)),l?(this.resetInternal(),this.dispatchEvent(new a.DataGridProviderRefreshEvent)):(t&&this.dispatchEvent(new a.DataGridProviderRemoveEvent(t)),r&&this.dispatchEvent(new a.DataGridProviderAddEvent(r)),s&&this.dispatchEvent(new a.DataGridProviderUpdateEvent(s)))}_convertEventDetail(e,t,a){let s,i=[],r=!1,o=0;if(e.keys.forEach(t=>{let s=e.indexes?.[o],n=this._getKeyCacheIndexByKey(t);-1!=n?i.push({index:n,key:t}):null!=s?i.push({index:s,key:t}):a&&(r=!0),o++}),i.length>0)if("remove"===t||"add"===t){s={axis:"row",ranges:i.map(e=>({offset:e.index,count:1})),version:this.version}}else if("update"===t){s={ranges:i.map(e=>({rowOffset:e.index,rowCount:1,columnOffset:0,columnCount:-1})),version:this.version}}return[r,s,i]}_handleUnderlyingRefresh(e){this.version++;let t,s=this.isKeyCacheSparse(),i=!0;if(null!=e?.detail?.disregardAfterKey){const a=this._getKeyCacheIndexByKey(e.detail.disregardAfterKey);if(-1!==a)t={disregardAfterRowOffset:a},this.keyCache.length=a+1,this.totalRowCount=-1===this.totalRowCount?-1:a+1,this.lastRowKeyCached=!1,i=!1;else if(!s)return}i&&this.resetInternal();const r=new a.DataGridProviderRefreshEvent(t);this.dispatchEvent(r)}_getKeyCacheIndexByKey(e){return this.keyCache.findIndex(a=>t.Object.compareValues(a,e))}resetInternal(){this._clearKeyCache(),this.totalRowCount=null,this.currentFetchParameters=null,this.sortCriteria=null,this.lastRowKeyCached=!1}}s.EventTargetMixin.applyMixin(r),e.RowDataGridProvider=r,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ojrowdatagridprovider.js.map