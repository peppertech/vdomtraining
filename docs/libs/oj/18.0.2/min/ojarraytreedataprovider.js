/**
 * @license
 * Copyright (c) 2014, 2025, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore-base","jquery","ojs/ojarraydataprovider","ojs/ojeventtarget","ojs/ojlogger"],function(e,t,r,s,i){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e,t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,r=r&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r;
/**
   * @preserve Copyright 2013 jQuery Foundation and other contributors
   * Released under the MIT license.
   * http://jquery.org/license
   */
class o{constructor(e,t,s){var i;this.treeData=e,this.options=t,this._rootDataProvider=s,this.TreeAsyncIterator=class{constructor(e,t){this._parent=e,this._baseIterable=t}next(){return this._baseIterable[Symbol.asyncIterator]().next().then(e=>{const t=e.value.metadata;for(let r=0;r<t.length;r++)t[r]=this._parent._getTreeMetadata(t[r],e.value.data[r]);return e})}},this.TreeAsyncIterable=(i=class{constructor(e,t){this._parent=e,this._asyncIterator=t,this[Symbol.asyncIterator]=()=>this._asyncIterator}},Symbol.asyncIterator,i),this._baseDataProvider=new r(e,t),this._mapKeyToNode=new Map,this._mapNodeToKey=new Map,this._mapArrayToSequenceNum=new Map,this._mapKoArrayToSubscriptions=new Map,this._mapKeyToParentNodePath=new Map,this._parentNodeKeys=new Set,this._childrenAttr=this.options&&this.options.childrenAttribute?this.options.childrenAttribute:"children",null==s?(this._parentNodePath=[],this._processTreeArray(e,[])):this._getTreeKeys(this.treeData)}containsKeys(e){return this.fetchByKeys(e).then(t=>{const r=new Set;return e.keys.forEach(e=>{null!=t.results.get(e)&&r.add(e)}),Promise.resolve({containsParameters:e,results:r})})}getCapability(e){return this._baseDataProvider.getCapability(e)}getTotalSize(){return this._baseDataProvider.getTotalSize()}isEmpty(){return this._baseDataProvider.isEmpty()}createOptimizedKeySet(e){return this._baseDataProvider.createOptimizedKeySet(e)}createOptimizedKeyMap(e){return this._baseDataProvider.createOptimizedKeyMap(e)}getChildDataProvider(e,t){const r=this._getRootDataProvider(),s=this._getNodeForKey(e);if(s){const t=this._getChildren(s);if(t){const s=new o(t,this.options,r);if(null!=s){const i=this.options?.enforceKeyStringify,o="on"===i?e:JSON.stringify(e);s._parentNodePath=r._mapKeyToParentNodePath.get(o),r.addEventListener("refresh",e=>{s._getTreeKeys(t)}),r.addEventListener("mutate",e=>{s._getTreeKeys(t)})}return s}}return null}fetchFirst(e){e=this._applyLeafNodeFilter(e);const t=this._baseDataProvider.fetchFirst(e);return new this.TreeAsyncIterable(this,new this.TreeAsyncIterator(this,t))}fetchByOffset(e){e=this._applyLeafNodeFilter(e);return this._baseDataProvider.fetchByOffset(e).then(t=>{const r=t.results,s=[];for(const e of r){let t=e.metadata;const r=e.data;t=this._getTreeMetadata(t,r),s.push({data:r,metadata:t})}const i={done:t.done,fetchParameters:t.fetchParameters,results:s};return"enabled"===e.includeFilteredRowCount&&(i.totalFilteredRowCount=t.totalFilteredRowCount),i})}fetchByKeys(e){const t=new Map;return e.keys.forEach(e=>{if(0===this._parentNodePath.length||this._parentNodeKeys.has(e)){const r=this._getNodeForKey(e);r&&t.set(e,{metadata:{key:e},data:r})}}),Promise.resolve({fetchParameters:e,results:t})}_getTreeKeys(e){const t=e instanceof Array?e:e();for(const e of t){const t=this._getKeyForNode(e);this._parentNodeKeys.add(t),e[this._childrenAttr]&&this._getTreeKeys(e[this._childrenAttr])}}_getChildren(e){return this._getVal(e,this._childrenAttr,!0)}_getRootDataProvider(){return this._rootDataProvider?this._rootDataProvider:this}_subscribeObservableArray(t,r){if("function"!=typeof t||!t.subscribe||void 0===t.destroyAll)throw new Error("Invalid data type. ArrayTreeDataProvider only supports Array or observableArray.");let s=null,i=null;const o=new Array(2);o[0]=t.subscribe(o=>{let a,n,h,l=[],d=[],y=[],u=[];const c=[];let p=null,_=null,f=null;const g=new Set,b=[],v=[];for(let e=0;e<o.length;e++)v[e]={index:o[e].index,status:o[e].status};for(let e=0;e<v.length;e++){const t=v[e].index,r=v[e].status;if("deleted"===r)for(let e=0;e<v.length;e++)"deleted"===v[e].status&&v[e].index>t&&v[e].index--;else if("added"===r)for(let e=0;e<v.length;e++)"added"===v[e].status&&v[e].index>t&&v[e].index++}for(a=0;a<v.length;a++){h=v[a].index,status=v[a].status;const t=this._getId(o[a].value);if(t)for(n=0;n<v.length;n++)if(n!==a&&h===v[n].index&&status!==v[n].status&&c.indexOf(a)<0&&b.indexOf(a)<0){const r=this._getId(o[n].value);e.Object.compareValues(t,r)&&("deleted"===status?(b.push(a),c.push(n),this._releaseNode(o[a].value)):(b.push(n),c.push(a)),this._compareChildren(o[a].value,o[n].value)||g.add(t))}}for(a=0;a<o.length;a++)if("deleted"===o[a].status&&c.indexOf(a)<0&&b.indexOf(a)<0){const e=o[a].value,t=this._getKeyForNode(e);d.push(t),l.push(e),y.push(o[a].index),this._releaseNode(e)}if(d.length>0){u=d.map(e=>({key:e}));const e=new Set;d.forEach(t=>{e.add(t)}),f={data:l,indexes:y,keys:e,metadata:u}}l=[],d=[],y=[],u=[];const K=t(),m=[],A=[],N=[],P=[];for(a=0;a<o.length;a++)if("added"===o[a].status&&b.indexOf(a)<0){const e=o[a].value,s=this._processNode(e,r,t);c.indexOf(a)<0?(d.push(s.key),l.push(e),y.push(o[a].index),u.push({key:s.key})):(m.push(s.key),A.push(e),N.push(o[a].index),P.push({key:s.key}))}if(d.length>0){const e=new Set;d.forEach(t=>{e.add(t)});const t=new Set,s=[],i=[];let o;o=this.options&&this.options.keyAttributes&&"siblings"!==this.options.keyAttributesScope&&"on"!==this.options.enforceKeyStringify?r.length>0?r[r.length-1]:null:r.length>0?r:null,y.forEach(e=>{let r;r=e>=K.length-1?null:this._getKeyForNode(K[e+1]),t.add(r),s.push(r),i.push(o)}),_={afterKeys:t,addBeforeKeys:s,parentKeys:i,data:l,indexes:y,keys:e,metadata:u}}if(m.length>0){const e=new Set;m.forEach(t=>{e.add(t)}),p={data:A,indexes:N,keys:e,metadata:P}}(_||f||p)&&(s=new e.DataProviderMutationEvent({add:_,remove:f,update:p})),g.size&&(i=new e.DataProviderRefreshEvent({keys:g}))},null,"arrayChange"),o[1]=t.subscribe(t=>{s||i?(s&&this.dispatchEvent(s),i&&this.dispatchEvent(i)):(this._flushMaps(),this._processTreeArray(this.treeData,[]),this.dispatchEvent(new e.DataProviderRefreshEvent)),s=null,i=null},null,"change"),this._mapKoArrayToSubscriptions.set(t,o)}_flushMaps(){const e=this._getRootDataProvider();e._mapKeyToNode.clear(),e._mapNodeToKey.clear(),e._mapArrayToSequenceNum.clear(),e._mapKoArrayToSubscriptions.forEach((e,t)=>{this._unsubscribeObservableArray(t)})}_unsubscribeObservableArray(e){if("function"==typeof e&&e.subscribe&&void 0!==e.destroyAll){const t=this._mapKoArrayToSubscriptions.get(e);t&&(t[0].dispose(),t[1].dispose(),this._mapKoArrayToSubscriptions.delete(e))}}_processTreeArray(e,t){let r;e instanceof Array?r=e:(this._subscribeObservableArray(e,t),r=e()),r.forEach((r,s)=>{this._processNode(r,t,e)})}_releaseTreeArray(e){let t;e instanceof Array?t=e:(this._unsubscribeObservableArray(e),t=e()),t.forEach((e,t)=>{this._releaseNode(e)})}_processNode(e,t,r){const s=this._createKeyObj(e,t,r);this._setMapEntry(s.key,e);const i=this.options?.enforceKeyStringify,o=this._getRootDataProvider(),a="on"===i?s.key:JSON.stringify(s.key);o._mapKeyToParentNodePath.set(a,s.keyPath);const n=this._getChildren(e);return n&&this._processTreeArray(n,s.keyPath),s}_releaseNode(e){const t=this._getKeyForNode(e);this._deleteMapEntry(t,e);const r=this._getChildren(e);r&&this._releaseTreeArray(r)}_createKeyObj(e,t,r){let s=this._getId(e);const i=t?t.slice():[],o=this.options?.enforceKeyStringify;return null==s?(this._setUseIndexAsKey(!0),i.push(this._incrementSequenceNum(r)),s="on"===o?JSON.stringify(i):i):("on"===o?i.push(JSON.parse(s)):i.push(s),!this.options||"siblings"!==this.options.keyAttributesScope&&"on"!==o||(s="on"===o?JSON.stringify(i):i)),{key:s,keyPath:i}}_getId(e){let t;const r=null!=this.options?this.options.keyAttributes:null,s=this.options?.enforceKeyStringify;if(null!=r){if(Array.isArray(r)){t=[];for(let s=0;s<r.length;s++)t[s]=this._getVal(e,r[s])}else t="@value"==r?this._getAllVals(e):this._getVal(e,r);return"on"===s?JSON.stringify(t):t}return null}_getVal(e,t,r){if("string"==typeof t){const r=t.indexOf(".");if(r>0){const s=t.substring(0,r),i=t.substring(r+1),o=e[s];if(o)return this._getVal(o,i)}}return!0!==r&&"function"==typeof e[t]?e[t]():e[t]}_getAllVals(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e?e:Object.keys(e).map(t=>this._getVal(e,t))}_getNodeMetadata(e){return{key:this._getKeyForNode(e)}}_getNodeForKey(e){const t=this.options?.enforceKeyStringify,r="on"===t?e:JSON.stringify(e);return this._getRootDataProvider()._mapKeyToNode.get(r)}_getKeyForNode(e){return this._getRootDataProvider()._mapNodeToKey.get(e)}_setMapEntry(e,t){const r=this.options?.enforceKeyStringify,s=this._getRootDataProvider(),o="on"===r?e:JSON.stringify(e);s._mapKeyToNode.has(o)&&i.warn(`Duplicate key ${o} found in ArrayTreeDataProvider.  Keys must be unique when keyAttributes ${this.options.keyAttributes} is specified`),s._mapKeyToNode.set(o,t),s._mapNodeToKey.set(t,e)}_deleteMapEntry(e,t){const r=this.options?.enforceKeyStringify,s=this._getRootDataProvider(),i="on"===r?e:JSON.stringify(e);s._mapKeyToNode.delete(i),s._mapNodeToKey.delete(t)}_incrementSequenceNum(e){const t=this._getRootDataProvider(),r=t._mapArrayToSequenceNum.get(e)||0;return t._mapArrayToSequenceNum.set(e,r+1),r}_getUseIndexAsKey(){return this._getRootDataProvider()._useIndexAsKey}_setUseIndexAsKey(e){return this._getRootDataProvider()._useIndexAsKey=e}_getLeafNodeFilter(e){return{op:"$or",criteria:[e,{op:"$and",criteria:[{op:"$ne",attribute:this._childrenAttr,value:null},{op:"$ne",attribute:this._childrenAttr,value:void 0}]}]}}_applyLeafNodeFilter(e){if(e&&e.filterCriterion){const r=t.extend({},e);r.filterCriterion=this._getLeafNodeFilter(r.filterCriterion),r.filterCriterion.filter=e.filterCriterion.filter,e=r}return e}_getTreeMetadata(e,t){let r=!1,s=e.key;return(null==this.options||null==this.options.keyAttributes||"siblings"==this.options.keyAttributesScope||"@index"==this.options.keyAttributes||this._getUseIndexAsKey()||"on"===this.options.enforceKeyStringify)&&(r=!0),r&&(s=this._parentNodePath?this._parentNodePath.slice():[],"on"===this.options?.enforceKeyStringify?(s.push(JSON.parse(e.key)),s=JSON.stringify(s)):s.push(e.key)),e=this._getNodeMetadata(this._getNodeForKey(s))}_compareChildren(t,r){let s=!0;const i=t[this._childrenAttr],o=r[this._childrenAttr],a="function"==typeof i?i():i,n="function"==typeof o?o():o;if(!a&&n||a&&!n)s=!1;else if(a&&n)if(a.length!==n.length)s=!1;else for(let t=0;t<a.length;t++)if(!e.Object.compareValues(a[t],n[t])){s=!1;break}return s}}return s.EventTargetMixin.applyMixin(o),e._registerLegacyNamespaceProp("ArrayTreeDataProvider",o),o});
//# sourceMappingURL=ojarraytreedataprovider.js.map